\documentclass[twoside,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[a4paper,bindingoffset=0.5cm,inner=2.5cm,outer=2cm,top=2.5cm,bottom=2.5cm]{geometry}
%\usepackage[a4paper,bindingoffset=1cm,inner=2cm,outer=2cm,top=2.5cm,bottom=2.5cm]{geometry} %,showframe
\usepackage{helvet}
\usepackage[T1]{fontenc}
\renewcommand{\familydefault}{\sfdefault}
% \usepackage[german,ngerman]{babel}
\usepackage[english]{babel}
\usepackage{graphicx}
\usepackage{amsmath,amsthm,amstext,amssymb,bm}
\usepackage{xcolor,color}
\usepackage{pifont}
\usepackage{array}
\usepackage{upgreek}
\usepackage{enumerate}
\usepackage{pgf}
\usepackage{mathrsfs}
\usepackage{subfig}
\usepackage{tabularx}
\usepackage[numbers]{natbib}
\usepackage{multirow}
\usepackage{makecell}
%%% Title page
\usepackage{common/titlePageST}
%%% Appendix in TOC
\usepackage[toc,page]{appendix}
%%% Setstrech on title page
\usepackage{setspace}
%%% Tilde in URL in literature
\usepackage{url}
%%% multiple rows
\usepackage{multirow}
%%% fancy column and row seperators
\usepackage{hhline}
%%% custom items in enumerate and itemize
\usepackage{enumitem}

\clubpenalty=5000
\widowpenalty=5000

\setlength{\emergencystretch}{2cm}
%----------------------------------------------------------------------------------------
%	abbreviation includes
%----------------------------------------------------------------------------------------
\input{common/default_abbrev}
\input{common/specific_abbrev}
%%% Clever refing
\usepackage[capitalise,noabbrev]{cleveref}

%----------------------------------------------------------------------------------------
%	References with cleveref
%----------------------------------------------------------------------------------------
\crefformat{equation}{(#2#1#3)}

%----------------------------------------------------------------------------------------
%	Theorem environments
%----------------------------------------------------------------------------------------
\newtheorem{theorem}{Theorem}
\newtheorem{example}{Example}
\newtheorem{corollary}{Corollary}
\newtheorem{lemma}{Lemma}

%----------------------------------------------------------------------------------------
%	fancyhdr
%----------------------------------------------------------------------------------------
\usepackage{fancyhdr}

\makeatletter
\newcommand{\theauthor}{Steffen Müller} %
\makeatother

\renewcommand{\headrulewidth}{0.3pt}
\renewcommand{\footrulewidth}{0.3pt}
\fancyfoot[OL,ER]{University of Stuttgart} % inner
\fancyfoot[OR,EL]{\thepage} % outer
\fancyhead[OL,ER]{\theauthor} % inner 
\fancyhead[OR,EL]{IANS -- Institute of Applied Analysis and Numerical Simulation} % outer
\fancyfoot[C]{}

% \headsep=4mm
% \footskip=4mm
\parindent=0mm
\parskip=6pt
% \renewcommand{\footskip}{3pt}

%----------------------------------------------------------------------------------------
%	Something
%----------------------------------------------------------------------------------------
\usepackage{textpos}
\setlength{\TPHorizModule}{1mm}%
\setlength{\TPVertModule}{1mm}%
% \headsep=5mm
% \footskip=5mm
\pagestyle{fancy}
\newcommand{\articleheading}[3]{
{\large #1}\\[3mm]
{\Large\bf #2}\\[3mm]
{\large #3}
}

%----------------------------------------------------------------------------------------
%	Start Document
%----------------------------------------------------------------------------------------
\begin{document}
\pagenumbering{roman}
%----------------------------------------------------------------------------------------
%
% TITLE PAGE
%
%----------------------------------------------------------------------------------------
%------------------------------------------
\begin{titlePageST}
%------------------------------------------
\makeLogo%
{-10pt}{
\includegraphics[width=0.7\textwidth]{figures/logos/simtech.pdf}
}%
{0pt}{
	\begin{center}
		\includegraphics[width=0.4\textwidth]{figures/logos/ians.pdf}
	\end{center}}%
{0pt}{
\begin{flushright}
	\vspace{-10pt}
	\includegraphics[width=0.9\textwidth]{figures/logos/unistuttgart_logo_englisch_cmyk.eps}
\end{flushright}}%
\vspace{35pt}%
%------------------------------------------
\makeHeader%
[Research Group: Numerical Mathematics] %
{Institute of Applied Analysis and Numerical Simulation} %
\vspace{50pt}%
%------------------------------------------
\makeTitle%
{Simulation Technology Degree Course} %
{Bachelor Thesis} %
\vspace{80pt}%
%------------------------------------------
\makeTitleThesis%
{Symplectic Neural Networks}
\vspace{90pt}%
%------------------------------------------
\begin{supervisorST}{3}%
\addSuper%
{First Reviewer}%
{Prof. Dr. B. Haasdonk}%
{Institute of Applied Analysis and\\[-0.2cm]
Numerical Simulation (IANS)}%
\addSuper%
{Second Reviewer}%
{Prof. Dr. D. Pflüger}%
{Institute of Parallel and Distributed\\[-0.2cm]
Systems (Scientific Computing)}%
\addSuper%
{Advisor}%
{Patrick Buchfink, M.Sc.}%
{Institute of Applied Analysis and\\[-0.2cm]
Numerical Simulation (IANS)}%
\end{supervisorST}%
\vspace{80pt}%
%------------------------------------------
\begin{authorST}{Submitted by}%
\addAuthorInfo{Author}{Steffen Müller}
\addAuthorInfo{Student ID}{3260643}
\addAuthorInfo{SimTech ID}{119} %
\addAuthorInfo{Submission Date}{...} %FILLIN
\end{authorST}%
%------------------------------------------
\end{titlePageST}
%----------------------------------------------------------------------------------------
\clearpage
\newpage\thispagestyle{plain}\null
\newpage\thispagestyle{plain}

%----------------------------------------------------------------------------------------
%
% ABSTRACT
%
%----------------------------------------------------------------------------------------
\section*{Abstract}
...
\clearpage
\newpage\thispagestyle{plain}\null
\newpage\thispagestyle{plain}

%----------------------------------------------------------------------------------------
%
% ACKNOWLEDGEMENTS
%
%----------------------------------------------------------------------------------------
\section*{Acknowledgements}
...
\clearpage
\newpage\thispagestyle{plain}\null
\newpage\thispagestyle{plain}

%----------------------------------------------------------------------------------------
%
% TOC
%
%----------------------------------------------------------------------------------------
\setcounter{tocdepth}{2}
\tableofcontents
\clearpage
\newpage\thispagestyle{plain}\null
%----------------------------------------------------------------------------------------
%
% Begin with document content
%
%----------------------------------------------------------------------------------------
\newpage
\pagenumbering{arabic} 
%----------------------------------------------------------------------------------------
%
% Introduction
%
%----------------------------------------------------------------------------------------
\section{Introduction}

\subsection{Outline}

\subsection{Notation}

Let $ f: \mathbb{R} \rightarrow \mathbb{R} $ be an arbitrary function. We denote
the element-wise application of $f$ on a vector $x \in \mathbb{R}^n$ with:

\begin{equation*}
	[f]_n: \mathbb{R}^n \rightarrow \mathbb{R}^n, \quad 
	[f]_n(x_1, ... x_n) := \begin{pmatrix}
		f(x_1) \\
		\vdots \\
		f(x_n)
	\end{pmatrix}
\end{equation*}

\todo{Introduce block matrix notation for general functions}

%----------------------------------------------------------------------------------------
%
% Content
%
%----------------------------------------------------------------------------------------
\newpage
\section{Problem setup}

\section{Architecture}

In this section we first recapitulate the symplectic layers proposed by Jin et. al 
in \cite{Jin2020} \todo{How to cite with name?}. Additionally we supplement proofs for 
symplecticity. A similar architecture was initially proposed by Deco in \cite{Deco1995} 
\todo{Have a deeper look at \cite{Deco1995}}. In the second part of this section 
we propose new symplectic layers.

\begin{lemma}\label{jacobi_symmetric}
	Let
	\begin{equation*}
		f_{up} := \begin{bmatrix}
			I & g \\
			0 & I
		\end{bmatrix} \begin{pmatrix}
			q \\
			p
		\end{pmatrix}
	\end{equation*}
	and
	\begin{equation*}
		f_{low} := \begin{bmatrix}
			I & 0 \\
			g & I
		\end{bmatrix} \begin{pmatrix}
			q \\
			p
		\end{pmatrix}
	\end{equation*}
	where $g: \mathbb{R}^d \rightarrow \mathbb{R}^d \in C^1$. 

	$f_{up}$ and $f_{low}$ are symplectic if and only if the Jacobi matrix of $g$, $Dg$,
	is symmetric.
\end{lemma}
\begin{proof}
	We show the result only for $f_{up}$. The calculation is analogous for $f_{low}$.

	\begin{equation*}
		Df_{up} = \begin{pmatrix}
			I & Dg \\
			0 & I
		\end{pmatrix}
	\end{equation*}
	It follows
	\begin{align*}
		\left(Df_{up}\right)^TJ(Df_{up}) &= \left(Df_{up}\right)^T \begin{pmatrix}
			0 & I \\
			-I & -Dg
		\end{pmatrix} \\
		&= \begin{pmatrix}
			I & 0 \\
			(Dg)^T & Id
		\end{pmatrix} \begin{pmatrix}
			0 & I \\
			-I & -Dg
		\end{pmatrix} \\
		&= \begin{pmatrix}
			0 & I \\
			-I & (Dg)^T-Dg
		\end{pmatrix}
	\end{align*}
	Thus, $f_{up}$ is symplectic if and only if $(Dg)^T-Dg=0$, i.e. if and only if $Dg$
	is symmetric.
\end{proof}

\begin{corollary}\label{matrix_symmetric}
	Let
	\begin{equation*}
		f_{up} := \begin{pmatrix}
			I & S \\
			0 & I
		\end{pmatrix} \begin{pmatrix}
			q \\
			p
		\end{pmatrix}
	\end{equation*}
	and
	\begin{equation*}
		f_{low} := \begin{pmatrix}
			I & 0 \\
			S & I
		\end{pmatrix} \begin{pmatrix}
			q \\
			p
		\end{pmatrix}
	\end{equation*}
	where $S \in \mathbb{R}^{dxd}$. 

	$f_{up}$ and $f_{low}$ are symplectic if and only if the matrix $S$
	is symmetric.
\end{corollary}

The next corollary is useful to construct symplectic maps.
\begin{corollary}\label{gradient_corollary}
	Let $V \in C^2(\mathbb{R}^d, \mathbb{R})$. Then
	\begin{equation*}
		f_{up} := \begin{bmatrix}
			I & \grad{V} \\
			0 & I
		\end{bmatrix} \begin{pmatrix}
			q \\
			p
		\end{pmatrix}
	\end{equation*}
	and
	\begin{equation*}
		f_{low} := \begin{bmatrix}
			I & 0 \\
			\grad{V} & I
		\end{bmatrix} \begin{pmatrix}
			q \\
			p
		\end{pmatrix}
	\end{equation*}
	define a symplectic map.
\end{corollary}
\begin{proof}
	The Jacobi matrix of $\nabla V$ corresponds to the Hessian matrix of $V$,
	i.e. $D(\nabla V) = HD$. \todo{Notation for Hessian}
	The Hessian is symmetric, thus the result follows with Lemma \ref{jacobi_symmetric}.
\end{proof}

\todo{Relation to 'Generating functions' in literature?}

\subsection{Linear layers}

It follows directly from Corollary \ref{matrix_symmetric} that the linear layers are
symplectic. Alternatively, we can apply Corollary \ref{gradient_corollary} by
choosing $V(x) = x^TSx$.
\todo{Not completely correct, is something else than plain $S$,
see my 'Gradient module' notes}

\todo{It does not make sense to put two upper or lower linear layers after each other,
because this reduces to a single linear layer.}

\subsection{Activation layers}

\subsection{Gradient layers}

\begin{equation*}
	\mathcal{G}_{up} \begin{pmatrix}
		q \\
		p
	\end{pmatrix} := \begin{bmatrix}
		I & \hat{\sigma} \\
		0 & I
	\end{bmatrix} \begin{pmatrix}
		q \\
		p
	\end{pmatrix} := \begin{pmatrix}
		q + K^T diag(a) [\sigma]_n(Kp + b) \\
		p
	\end{pmatrix}
\end{equation*}
\begin{equation*}
	\mathcal{G}_{low} \begin{pmatrix}
		q \\
		p
	\end{pmatrix} := \begin{bmatrix}
		I & 0 \\
		\hat{\sigma} & I
	\end{bmatrix} \begin{pmatrix}
		q \\
		p
	\end{pmatrix} := \begin{pmatrix}
		q \\
		K^T diag(a) [\sigma]_n(Kq + b) + p
	\end{pmatrix}
\end{equation*}
where $K \in \mathbb{R}^{nxd}$ and $a,b \in \mathbb{R}^n$.
\todo{Describe n and d}

\newtheorem*{glayer}{Lemma}
\begin{glayer}
	Given an activation function $\sigma \in C^1$ the gradient layers $\mathcal{G}_{\{up,low\}}$ 
	are symplectic.
\end{glayer}
\begin{proof}
	Let $V(p) := 1_n^Tdiag(a)[\int \sigma]_n(Kp+b)$ \todo{Notation for 1-vector? Notation antiderivative?}

	Then $V \in C^2(\mathbb{R}^d, \mathbb{R})$ and
	\begin{align*}
		\nabla V(p) &= \left(DV(p)\right)^T \\
		&= \left(1_n^Tdiag(a)diag\left([\sigma]_n(Kp+b)\right)K\right)^T \\
		&= K^Tdiag(a)diag\left([\sigma]_n(Kp+b)\right)1_n \\
		&= K^Tdiag(a)[\sigma]_n(Kp+b)
	\end{align*}

	With Corollary \ref{gradient_corollary} follows that the Gradient layers $\mathcal{G}_{\{up,low\}}$
	are symplectic. \todo{Best way to reference other theorems?}
\end{proof}

\subsection{Scaling layers}

\subsection{Convolution layers}

\todo{Try motivating convolution layers by showing that the linear layers explode if $d$ becomes large.}

\todo{Bias important if non-zero Dirichlet boundaries, but only at borders!}

\section{Relation to geometric integrators}

\section{Experiments}

\subsection{Low-dimensional systems}

\subsection{High-dimensonal systems}

\todo{Describe Hamiltonian PDEs. A PDE describes system locally, thus it makes sense to share parameters, for
example in the form of CNNs etc.}

Assumptions:
\begin{itemize}
	\item Original PDE has constant coefficients \todo{Or rather should not depend on $x$ itself?}
	\item Equidistant grid points
\end{itemize}

\todo{Explain why we need assumptions.}

\subsubsection{Linear wave equation in one dimension}

\todo{The choice of basis for the symmetric convolution kernels is critical (at least for fast convergence)!}

\subsubsection{Sine-Gordon}

\todo{Activation layer with sin works well if $a \in \mathbb{R}$, i.e. activation function is applied
isotropic.}

\subsubsection{Linear wave equation in two dimensions}

\subsubsection{Linear elastic beam in three dimensions}

\section{Implementation}

\todo{Describe use of PyTorch, TensorBoard, Docker, MLFlow, Unit Tests, ...}

%----------------------------------------------------------------------------------------
%
% Resume
%
%----------------------------------------------------------------------------------------
\clearpage\newpage\null %empty page
\newpage
\section{R\'esum\'e}
\subsection{Summary and conclusion}

\subsection{Outlook}

%----------------------------------------------------------------------------------------
%
% Appendices
%
%----------------------------------------------------------------------------------------
\clearpage\newpage\null %empty page
\newpage
\begin{appendices}
\addtocontents{toc}{\protect\setcounter{tocdepth}{1}}
\section{First Appendix Section}

\newpage~\newpage
\section{Declaration of authorship}

\vspace{3cm}

\begin{table}[h!]
\centering
\begin{tabular}{|p{13cm}|}
\hline\\
	I hereby certify
	\begin{enumerate}
		\item that this thesis has been composed by me and is based on my own work, unless stated otherwise,
		\item that all direct or indirect sources used are acknowledged as references and all extracts from work of others, either verbatim or in spirit, are stated as such,
		\item that neither the thesis itself nor parts of this thesis have been part of another examination procedure,
		\item that neither the thesis itself nor parts of this thesis have been published and
		\item that all copies of this thesis, either digital or printed, coincide.
	\end{enumerate}
	Therewith, this declaration of authorship is in accordance with the examination regulations from 29th July 2013 of the master's program \emph{Simulation Technology} of the University of Stuttgart.\\\\
\hline
\end{tabular}
\end{table}

\vspace{4cm}
\hrulefill\\
Name
\hspace{7cm}
Date, City, Signature
\end{appendices}
%----------------------------------------------------------------------------------------
%
% BIBLIOGRAPHY
%
%----------------------------------------------------------------------------------------
\clearpage\newpage\null %empty page
\newpage
\addtocontents{toc}{\protect\setcounter{tocdepth}{1}}
\addcontentsline{toc}{section}{References}
\bibliographystyle{abbrvnat}
\bibliography{../../literature/references.bib}

\end{document}
